<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Zoomable Canvas with Grid and Shapes</title>
    <style>
      body,
      html {
        margin: 0;
        padding: 0;
        overflow: hidden;
      }
      canvas {
        display: block;
      }
    </style>
  </head>
  <body>
    <canvas id="myCanvas"></canvas>
    <script type="module">
      import { drawPentagon } from "./rendering.js";
      import { CanvasControls } from "./controls.js";

      const canvas = document.getElementById("myCanvas");
      const ctx = canvas.getContext("2d");

      let lastTime = 0;
      let budgetPercentage = 0;
      let fps = 0;

      function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        draw();
      }

      function draw() {
        const { scale, offsetX, offsetY } = controls.getTransform();

        ctx.save();
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.scale(scale, scale);
        ctx.translate(offsetX, offsetY);

        drawGrid();
        drawShapes();
        drawPerformanceMetrics();

        ctx.restore();
      }

      function drawGrid() {
        const { offsetX, offsetY } = controls.getTransform();
        ctx.fillStyle = "#cbd5e1";
        const gridSize = 20;
        const roundedX = Math.trunc(offsetX / gridSize) * gridSize;
        const roundedY = Math.trunc(offsetY / gridSize) * gridSize;
        for (let x = -roundedX; x < canvas.width - roundedX; x += gridSize) {
          for (let y = -roundedY; y < canvas.height - roundedY; y += gridSize) {
            ctx.beginPath();
            ctx.arc(x, y, 1, 0, Math.PI * 2);
            ctx.fill();
          }
        }
      }

      function update(currentTime) {
        requestAnimationFrame((time) => update(time));
        const startTime = performance.now();

        const deltaTime = currentTime - lastTime;
        lastTime = currentTime;

        draw();
        const endTime = performance.now();
        budgetPercentage = ((endTime - startTime) / deltaTime) * 100;
      }

      function drawShapes() {
        drawPentagon(ctx, 300, 300, 50, "rgba(255, 0, 255, 0.5)");
      }

      function drawPerformanceMetrics() {
        ctx.save();
        ctx.resetTransform(); // Reset any transformations

        ctx.font = "14px Arial";
        ctx.fillStyle = "black";
        ctx.textAlign = "right";
        ctx.textBaseline = "top";

        const metrics = `${budgetPercentage.toFixed(0)}%`;
        ctx.fillText(metrics, canvas.width - 10, 10);

        ctx.restore();
      }

      const controls = new CanvasControls(canvas, draw);

      // Initial setup
      resizeCanvas();
      update();

      // Event listeners
      window.addEventListener("resize", resizeCanvas);
    </script>
  </body>
</html>
